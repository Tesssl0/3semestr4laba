#include "rwlock.h"

// ------------------ Конструктор RWLock ------------------
// Инициализирует объект RWLock с заданным приоритетом
RWLock::RWLock(Priority p) : priority(p) {}

// ------------------ Метод lock_read ------------------
// Захватывает блокировку для чтения
// Читатель может войти, если выполнены условия в зависимости от приоритета
void RWLock::lock_read() {
    unique_lock<mutex> lk(m);  // Захват мьютекса для защиты общих переменных
    waiting_readers++;          // Увеличение счетчика ожидающих читателей

    // Ожидание выполнения условия для входа читателя
    cv.wait(lk, [&] {
        if (priority == Priority::Writers) {
            // Режим "приоритет писателей":
            // Читатель может войти только если:
            // 1. Нет активного писателя (writers == 0)
            // 2. Нет ожидающих писателей (waiting_writers == 0)
            return writers == 0 && waiting_writers == 0;
        }
        else {
            // Режим "приоритет читателей":
            // Читатель может войти, если нет активного писателя
            return writers == 0;
        }
        });

    waiting_readers--;  // Читатель больше не ожидает
    readers++;          // Увеличение счетчика активных читателей
}

// Освобождает блокировку чтения
void RWLock::unlock_read() {
    unique_lock<mutex> lk(m);
    readers--;  // Уменьшение счетчика активных читателей

    // Если не осталось активных читателей, разбудить все ожидающие потоки

    if (readers == 0)
        cv.notify_all();
}

// Захватывает блокировку для записи
// Писатель может войти, если выполнены условия в зависимости от приоритета
void RWLock::lock_write() {
    unique_lock<mutex> lk(m);
    waiting_writers++;  // Увеличение счетчика ожидающих писателей

    // Ожидание выполнения условия для входа писателя
    cv.wait(lk, [&] {
        if (priority == Priority::Writers) {
            // Режим "приоритет писателей":
            // Писатель может войти только если:
            // 1. Нет активных читателей (readers == 0)
            // 2. Нет активных писателей (writers == 0)
            return writers == 0 && readers == 0;
        }
        else {
            // Режим "приоритет читателей":
            // Писатель может войти только если:
            // 1. Нет активных читателей (readers == 0)
            // 2. Нет активных писателей (writers == 0)
            // 3. Нет ожидающих читателей (waiting_readers == 0)
            return writers == 0 && readers == 0 && waiting_readers == 0;
        }
        });

    waiting_writers--;  // Писатель больше не ожидает
    writers = 1;        // Установка флага активного писателя (только 1 может быть активным)
}

// Освобождает блокировку записи
void RWLock::unlock_write() {
    unique_lock<mutex> lk(m);
    writers = 0;        // Сброс флага активного писателя
    cv.notify_all();    // Пробуждение всех ожидающих потоков (и читателей, и писателей)
}